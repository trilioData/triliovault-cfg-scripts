---

- name: Stop tvault-objetc-store service if running
  service: name=tvault-object-store state=stopped
  ignore_errors: yes

- name: Stop tvault-contego service if running
  service: name=tvault-contego state=stopped
  ignore_errors: yes

- name: Setup trilio yum repo for queens
  template:
     src: trilio.repo
     dest: "{{trilio_yum_repo_file_path}}"

- name: Reload Daemon
  shell: systemctl daemon-reload

- name: Generate modules.dep and map files
  shell: depmod -a
  register: depmod_reg
  ignore_errors: yes

- debug:
    msg: "{{ depmod_reg }}"
  when: depmod_reg.rc != 0

- name: Create nbd 128 devices
  shell: sudo modprobe nbd nbds_max=128
  register: crt_nbd
  ignore_errors: yes

- debug:
    msg: "{{ crt_nbd }}"
  when: crt_nbd.rc != 0

- name: Create nbd config file
  lineinfile:
    path: /etc/modprobe.d/nbd.conf
    line: 'options nbd nbds_max=128'
    create: yes
  register: chk_nbd
  ignore_errors: yes

- debug:
    msg: "{{ chk_nbd }}"
  when: crt_nbd.changed == False

- name: Load nbd module into Linux Kernel
  lineinfile:
    path: /etc/modules-load.d/openstack-ansible.conf
    line: 'nbd'
    create: no
  register: loa_nbd
  ignore_errors: yes

- debug:
    msg: "{{ loa_nbd }}"
  when: loa_nbd.changed == False

- name: Install openstack-{{OPENSTACK_DIST}} repo if is not installed
  package:
    name: centos-release-openstack-{{OPENSTACK_DIST | lower}}
    state: latest
  register: inst_pckg

- name: install contego extension packages when using python2
  yum:
     update_cache: yes
     name:
        - puppet-triliovault
        - tvault-contego
     state: latest
  when: PYTHON_VERSION=="python2"
  
- name: install contego extension packages when using python3
  yum:
     update_cache: yes
     name:
        - puppet-triliovault
        - python3-tvault-contego
     state: latest
  when: PYTHON_VERSION=="python3"

- name: Remove recently installed openstack-{{OPENSTACK_DIST}} repo
  package:
    name: centos-release-openstack-{{OPENSTACK_DIST | lower}}
    state: absent
  when: (inst_pckg.changed == 'True')
