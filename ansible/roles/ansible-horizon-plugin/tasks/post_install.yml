---

- name: Found location of trilio.pth file
  shell: "{{virtual_env}} && {{ PYTHON_VERSION }} -c 'from distutils.sysconfig import get_python_lib; print(get_python_lib())'"
  register: VENV_PKGLIB
  when: ENV_PATH != "/usr"

- set_fact:
    TRILIO_FILE : "{{VENV_PKGLIB.stdout}}/trilio.pth"
  when: ENV_PATH != "/usr"

- name: Found local packages library
  shell: |
         /usr/bin/{{ PYTHON_VERSION }} -c "import site, os; from os import path; p = [path_dir for path_dir in site.getsitepackages() if path.exists(os.path.join(path_dir, 'dashboards'))]; print(p[0]+'/')"
  register: PACKAGELIB
  when: ENV_PATH != "/usr"

- set_fact:
    PACKAGE_LIB : "{{PACKAGELIB.stdout}}"
  when: ENV_PATH != "/usr"

- debug:
    msg: "TRILIO_FILE :{{TRILIO_FILE}} --- PACKAGE_LIB {{PACKAGE_LIB}}"
    verbosity: "{{ verbosity_level }}"

- name: Create trilio.pth file
  shell: "echo {{ PACKAGE_LIB }} > {{ TRILIO_FILE }}"
  when: ENV_PATH != "/usr"

##Centos

- block:
  - name: Find panel files
    find: 
      paths: /usr/lib/python3.6/site-packages/dashboards/local/enabled
      file_type: file
    register: rpm_panel_path

  - name: Copy panel files
    copy:
      src: "{{ item.path }}"
      dest: /usr/share/openstack-dashboard/openstack_dashboard/local/enabled
      remote_src: true
    loop: "{{ rpm_panel_path.files }}"
    notify:
      - restart webserver

  - name: Find template files
    find: 
      paths: /usr/lib/python3.6/site-packages/dashboards/templatetags
      file_type: file
    register: rpm_template_path

  - name: Copy template files
    copy:
      src: "{{ item.path }}"
      dest: /usr/share/openstack-dashboard/openstack_dashboard/templatetags
      remote_src: true
    loop: "{{ rpm_template_path.files }}"
    notify:
      - restart webserver
  when: >
        (ansible_distribution_major_version>="8" and ansible_distribution=="CentOS") or
        (ansible_distribution_major_version>="8" and ansible_distribution=="RedHat")


##Ubuntu
- block:
  - name: Find panel files
    find: 
      paths: /usr/lib/python3/dist-packages/dashboards/local/enabled
      file_type: file
    register: deb_panel_path

  - name: Copy panel files
    copy:
      src: "{{ item.path }}"
      dest: /usr/share/openstack-dashboard/openstack_dashboard/local/enabled
      remote_src: true
    loop: "{{ deb_panel_path.files }}"
    notify:
      - restart webserver

  - name: Find template files
    find: 
      paths: /usr/lib/python3/dist-packages/dashboards/templatetags
      file_type: file
    register: deb_template_path

  - name: Copy template files
    copy:
      src: "{{ item.path }}"
      dest: /usr/share/openstack-dashboard/openstack_dashboard/templatetags
      remote_src: true
    loop: "{{ deb_template_path.files }}"
    notify:
      - restart webserver
  when: >
        (ansible_distribution_major_version>="18.04" and ansible_distribution=="Ubuntu")
